<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRV報告掃描分析系統</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #374151; font-size: 1.8em; margin-bottom: 10px; }
        .header p { color: #6b7280; }
        
        .nav-tabs {
            display: flex;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            background: #f9fafb;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
        }
        .nav-tab.active { background: white; color: #374151; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .scan-section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .barcode-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1.1em;
            margin: 15px 0;
        }
        
        .scan-btn {
            background: #6b7280;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
        }
        .scan-btn:hover { background: #4b5563; }
        .demo-btn { background: #10b981; }
        .demo-btn:hover { background: #059669; }
        
        #status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            background: #f3f4f6;
            color: #6b7280;
        }
        #status.success { background: #dcfce7; color: #166534; }
        #status.error { background: #fef2f2; color: #dc2626; }
        
        .results {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        .results.show { display: block; }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .param-card {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .param-card h4 { color: #374151; margin-bottom: 10px; }
        .param-card .value { font-size: 1.8em; font-weight: bold; color: #111827; }
        .param-card .unit { font-size: 0.8em; color: #6b7280; }
        .param-card.normal .value { color: #10b981; }  /* 綠色文字 */
        .param-card.warning .value { color: #f59e0b; } /* 黃色文字 */
        .param-card.danger .value { color: #ef4444; }  /* 紅色文字 */
        
        .analysis-result {
            background: #f3f4f6;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .analysis-result h3 { font-size: 1.3em; margin-bottom: 10px; }
        
        .recommendations {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
        }
        .recommendations h4 { margin-bottom: 15px; color: #374151; }
        .recommendations ul { list-style: none; }
        .recommendations li {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }
        .recommendations li:before { content: "• "; color: #10b981; font-weight: bold; }
        
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 {
            color: #374151;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .range-input-group {
            display: grid;
            grid-template-columns: 1fr 100px 100px 150px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .range-input { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
        
        .classification-section { margin-bottom: 30px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        .add-classification-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
        }
        
        .classification-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .classification-item.type1 { border-left: 4px solid #f59e0b; }
        .classification-item.type2 { border-left: 4px solid #f59e0b; }
        .classification-item.type3 { border-left: 4px solid #ef4444; }
        .classification-item.normal { border-left: 4px solid #10b981; }
        .classification-item.custom1,
        .classification-item.custom2,
        .classification-item.custom3 { border-left: 4px solid #6366f1; }
        
        .classification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #6b7280; }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        
        .suggestions-list { margin-top: 10px; }
        .suggestion-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .suggestion-input { flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .remove-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
        }
        .add-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .save-btn {
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .reset-btn { background: #ef4444; }
        
        .disclaimer {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            color: #7f1d1d;
            text-align: center;
        }

        /* 新增樣式 */
        .input-method-tabs {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #d1d5db;
        }
        .method-tab {
            flex: 1;
            padding: 12px;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
            border-radius: 8px;
        }
        .method-tab.active { background: #10b981; color: white; }
        .method-tab:hover { background: #e5e7eb; }
        .method-tab.active:hover { background: #059669; }

        .input-section { display: none; margin: 15px 0; }
        .input-section.active { display: block; }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            margin: 15px 0;
        }
        .upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .upload-area.dragover {
            border-color: #10b981;
            background: #dcfce7;
        }

        .upload-content {
            color: #6b7280;
        }
        .upload-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .upload-hint {
            font-size: 0.9em;
            color: #9ca3af;
            margin-top: 5px;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .preview-info {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 0.9em;
            color: #6b7280;
        }

        .processing-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            text-align: center;
        }
        .processing-status.success {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }
        .processing-status.error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }
    
        /* 手機響應式設計 */
@media (max-width: 768px) {
    .container {
        padding: 10px;
        margin: 10px;
    }
    
    /* 或者更精確的選擇器，隱藏包含標題的那一行 */
    .range-input-group:not([data-param]) {
        display: none !important;
    }

    .range-input-group {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
    }
    
    /* 參數名稱標題 */
    .param-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #374151;
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    /* 數值輸入區域 */
    .value-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .input-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #6b7280;
    }
    
    .range-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1em;
        text-align: center;
    }
    
    /* 說明輸入區域 */
    .description-input {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .description-input .range-input {
        text-align: left;
        font-size: 0.9em;
    }
    
    .range-input:focus {
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
}
    
    .range-input-group label {
        font-weight: bold;
        color: #374151;
        margin-bottom: 5px;
    }
    
    .range-input {
        width: 100%;
        padding: 10px;
    }
    
    /* 參數卡片也要調整 */
    .parameters {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
    }
    
    .param-card {
        padding: 12px;
    }
    
    /* 建議列表調整 */
    .suggestion-item {
        flex-direction: column;
        gap: 5px;
    }
    
    .remove-btn {
        align-self: flex-start;
        width: fit-content;
    }
    
    /* 按鈕調整 */
    .scan-btn {
        padding: 12px 20px;
        margin: 3px;
        font-size: 0.9em;
    }
    
    /* 分類項目調整 */
    .classification-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    /* 狀態顯示調整 */
    #status {
        font-size: 0.9em;
        padding: 10px;
    }

@media (max-width: 480px) {
    .header h1 {
        font-size: 1.5em;
    }
    
    .nav-tab {
        padding: 12px 8px;
        font-size: 0.9em;
    }
    
    .parameters {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    
    .scan-section {
        padding: 15px;
    }
}

/* 在這裡新增HRV分級相關的CSS */
.hrv-grading-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.toggle-label {
    font-weight: 600;
    color: #374151;
}

.grading-info {
    background: #fffbeb;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 4px solid #f59e0b;
}

.grading-info ol {
    margin-left: 20px;
    color: #92400e;
}

.hrv-grade-item {
    border-left: 4px solid #6366f1 !important;
}

.parameter-ranges {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.param-range {
    background: #f9fafb;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    border: 1px solid #e5e7eb;
}

/* 在這裡新增HRV分級結果的樣式 */
.hrv-grading-result {
    margin: 15px 0;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid;
}

.hrv-grading-result h4 {
    margin-bottom: 10px;
    font-size: 1.1em;
}

.hrv-grading-result p {
    margin-bottom: 5px;
    line-height: 1.4;
}

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🔬 HRV報告掃描分析系統</h1>
            <p>掃描報告上的QR Code，立即獲得個人化分析結果</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('scanner')">📱 掃描分析</button>
            <button class="nav-tab" onclick="switchTab('settings')">⚙️ 自訂設定</button>
        </div>

        <div id="scanner-tab" class="tab-content active">
            <div class="scan-section">
                <label>🔍 選擇掃描方式：</label>
                
                <!-- 輸入方式選擇 -->
                <div class="input-method-tabs">
                    <button class="method-tab active" onclick="switchInputMethod('manual')">✏️ 手動輸入</button>
                    <button class="method-tab" onclick="switchInputMethod('qrcode')">📱 QR Code掃描</button>
                </div>

                <!-- 手動輸入區域 -->
                <div id="manual-input" class="input-section active">
                    <label>請輸入HRV數據：</label>
                    <input type="text" id="barcodeInput" class="barcode-input" 
                           placeholder="範例：RMSSD=52.4&pNN50=30&LF=615.2&HF=525.8&LFHF=1.2&SDNN=68.3">
                </div>

                <!-- QR Code上傳區域 -->
                <div id="qrcode-input" class="input-section">
                    <label>上傳QR Code圖片：</label>
                    <div class="upload-area" onclick="document.getElementById('qrcodeFile').click()">
                        <div class="upload-content">
                            <div class="upload-icon">📱</div>
                            <div>點擊上傳QR Code圖片</div>
                            <div class="upload-hint">支援 JPG, PNG, GIF 格式</div>
                        </div>
                    </div>
                    <input type="file" id="qrcodeFile" accept="image/*" style="display: none;" onchange="processQRCodeImage(this)">
                    <div id="qrcodePreview" class="image-preview"></div>
                </div>

                <div id="status">✏️ 手動輸入模式</div>
                
                <button class="scan-btn" onclick="analyzeData()">🔍 分析報告</button>
                <button class="scan-btn demo-btn" onclick="loadDemo()">📋 載入示範數據</button>
                <button class="scan-btn" onclick="clearInput()">🗑️ 清除</button>
            </div>

            <div id="results" class="results">
                <div class="result-header">
                    <h2 style="margin-bottom: 20px; line-height: 1.1;">📊 分析結果</h2>
        <p style="margin-bottom: 25px; line-height: 1;">基於您的HRV參數進行的自律神經功能評估</p>
                </div>
                <div id="parameters" class="parameters"></div>
                <div id="analysisResult" class="analysis-result"></div>
                <div class="recommendations">
                    <h4>💡 個人化建議</h4>
                    <ul id="recommendationsList"></ul>
                </div>
                <div class="disclaimer">
                    <strong>⚠️ 重要聲明：</strong>
                    本分析結果僅供參考，不構成醫療診斷。如有健康疑慮，請諮詢專業醫療人員。
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="settings-section">
                <h3>📊 HRV參數正常範圍設定</h3>
                <div class="range-input-group">
                    <label>參數名稱</label>
                    <label>最小值</label>
                    <label>最大值</label>
                    <label>說明</label>
                </div>
                <div id="parameterRanges"></div>
            </div>

            <div class="classification-section">
                <div class="section-header">
                    <h3>🏷️ 分類標準與建議設定</h3>
                </div>
                <div id="classificationList"></div>
            </div>

            <div class="settings-section">
                <button class="save-btn" onclick="saveSettings()">💾 儲存設定</button>
                <button class="save-btn reset-btn" onclick="resetToDefault()">🔄 恢復預設</button>
            </div>
        </div>
    </div>

    <script>
        let systemSettings = {
            parameterRanges: {
                'RMSSD': { min: 30, max: 100, description: '連續心跳間隔差異' },
                'pNN50': { min: 10, max: 50, description: '心跳變異程度' },
                'LF': { min: 300, max: 1500, description: '低頻功率' },
                'HF': { min: 300, max: 1000, description: '高頻功率' },
                'LFHF': { min: 0.5, max: 2.5, description: '自律神經平衡' },
                'SDNN': { min: 50, max: 150, description: '心跳變異標準差' }
            },
            classificationRules: {
                type1: { 
                    name: '類型一 - 交感神經過度活躍',
                    description: '個性容易緊張、工作壓力很大、生活步調緊湊的人',
                    condition: 'LFHF > 2.5',
                    supplements: ['穀維素', 'GABA'],
                    lifestyle: ['放鬆練習', '減少咖啡因', '深呼吸訓練']
                },
                type2: { 
                    name: '類型二 - 副交感神經過度活躍',
                    description: '活動量不足、缺乏運動的族群',
                    condition: 'LFHF < 0.5',
                    supplements: ['唐辛子', '人蔘皂甘'],
                    lifestyle: ['適度運動', '規律作息', '提升活力']
                },
                type3: { 
                    name: '類型三 - 多項指標異常',
                    description: '綜合性問題，需要全面性調理',
                    condition: '3個以上參數超出正常範圍',
                    supplements: ['唐辛子+穀維素', '人蔘皂甘+穀維素'],
                    lifestyle: ['就醫諮詢', '密切監控', '綜合調理']
                },
                normal: { 
                    name: '正常範圍',
                    description: '各項指標均在健康範圍內',
                    condition: '所有參數在正常範圍內',
                    supplements: ['維持現狀'],
                    lifestyle: ['保持良好習慣', '定期檢測']
                }
            },
            hrvGrading: {
                enabled: true,
                grades: {
                    grade1: {
                        name: '極佳恢復狀況',
                        rmssdRange: { min: 75, max: Infinity },
                        conditions: {
                             LFHF: { min: 0.3, max: 0.8 },
                             pNN50: { min: 30, max: Infinity }
                        },
                        color: '#10b981',
                        recommendations: ['維持現有生活型態', '定期監測保持狀態']
                    },
                    grade2: {
                        name: '良好平衡狀況',
                        rmssdRange: { min: 45, max: 75 },
                        conditions: {
                            LFHF: { min: 0.8, max: 2.0 },
                            pNN50: { min: 15, max: 30 }
                         },
                        color: '#22c55e',
                        recommendations: ['保持規律運動', '維持良好睡眠品質']
                    },
                    grade3: {
                        name: '輕度疲勞狀態',
                        rmssdRange: { min: 25, max: 45 },
                        conditions: {
                            LFHF: { min: 1.5, max: 3.0 },
                            pNN50: { min: 10, max: 20 }
                        },
                        color: '#eab308',
                        recommendations: ['適度休息調整', '注意壓力管理', '改善睡眠品質']
                    },
                    grade4: {
                        name: '中度壓力狀態',
                        rmssdRange: { min: 19, max: 30 },
                        conditions: {
                            LFHF: { min: 2.5, max: 4.0 },
                            pNN50: { min: 6, max: 10 }
                        },
                        color: '#f59e0b',
                        recommendations: ['需要充分休息', '建議減少工作壓力', '進行放鬆訓練']
                    },
                    grade5: {
                        name: '高度壓力狀態',
                        rmssdRange: { min: 12, max: 19 },
                        conditions: {
                            LFHF: { min: 3.5, max: 6.0 },
                            pNN50: { min: 3, max: 6 }
                        },
                        color: '#ef4444',
                        recommendations: ['立即休息調整', '尋求專業協助', '重新評估生活型態']
                    },
                    grade6: {
                        name: '極度壓力狀態',
                        rmssdRange: { min: 0, max: 12 },
                        conditions: {
                            LFHF: [{ min: 6.0, max: Infinity }, { min: 0, max: 0.3 }],
                            pNN50: { min: 0, max: 3 }
                        },
                        color: '#dc2626',
                        recommendations: ['緊急休息', '立即就醫諮詢', '全面生活型態調整']
                    }
                }
            }
        };

        let currentInputMethod = 'manual';

        function switchInputMethod(method) {
            currentInputMethod = method;
            
            // 更新按鈕狀態
            document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新輸入區域顯示
            document.querySelectorAll('.input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(method + '-input').classList.add('active');
            
            // 更新狀態顯示
            const statusMessages = {
                manual: '✏️ 手動輸入模式',
                qrcode: '📱 QR Code掃描模式 - 請上傳圖片'
            };
            
            document.getElementById('status').textContent = statusMessages[method];
            document.getElementById('status').className = '';
        }

function processQRCodeImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    updateStatus('🔄 正在處理QR Code圖片...', 'processing');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // 直接更新 upload-area 的內容
            const uploadArea = document.querySelector('#qrcode-input .upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="upload-content">
                        <img src="${img.src}" alt="QR Code預覽" style="max-width: 200px; max-height: 150px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">${file.name}</div>
                        <div style="font-size: 0.8em; color: #9ca3af;">正在識別中...</div>
                    </div>
                `;
            }
            
            // 模擬QR碼識別過程
            setTimeout(() => {
                const mockQRData = simulateQRCodeReading(file.name);
                if (mockQRData) {
                    document.getElementById('barcodeInput').value = mockQRData;
                    updateStatus('✅ QR Code讀取成功！', 'success');
                    
                    // 更新upload-area的狀態提示
                    if (uploadArea) {
                        const hintDiv = uploadArea.querySelector('.upload-content div:last-child');
                        if (hintDiv) {
                            hintDiv.textContent = '✅ 已讀取成功，點擊更換';
                            hintDiv.style.color = '#059669';
                        }
                    }
                } else {
                    updateStatus('❌ 無法識別QR Code，請嘗試其他圖片', 'error');
                    
                    // 更新upload-area的狀態提示
                    if (uploadArea) {
                        const hintDiv = uploadArea.querySelector('.upload-content div:last-child');
                        if (hintDiv) {
                            hintDiv.textContent = '❌ 無法識別，點擊重新上傳';
                            hintDiv.style.color = '#dc2626';
                        }
                    }
                }
            }, 2000);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// 在這裡新增 setupDragAndDrop 函數
function setupDragAndDrop() {
    const uploadAreas = document.querySelectorAll('.upload-area');
    
    uploadAreas.forEach(area => {
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    if (area.closest('#qrcode-input')) {
                        processQRCodeImage({ files: [file] });
                    }
                }
            }
        });
    });
}

        function displayImagePreview(containerId, imageSrc, fileName) {
            // 這個函數現在由 processQRCodeImage 直接處理
            // 保留空函數避免錯誤
        }

        function simulateQRCodeReading(fileName) {
            // 模擬不同的QR碼識別結果
            const mockResults = [
                "https://hospital.com/report?RMSSD=41.7&pNN50=22&LF=685.4&HF=445.9&LFHF=1.8&SDNN=71.2",
                "https://clinic.com/hrv-data?RMSSD=55.1&pNN50=35&LF=590.8&HF=580.3&LFHF=1.0&SDNN=82.6",
                "https://health.com/analysis?RMSSD=33.8&pNN50=15&LF=950.2&HF=285.4&LFHF=3.3&SDNN=58.9"
            ];
            
            // 根據檔名特性決定是否成功識別
            if (fileName.toLowerCase().includes('qr') || fileName.toLowerCase().includes('code')) {
                return mockResults[Math.floor(Math.random() * mockResults.length)];
            }
            
            // 80% 機率成功識別（QR碼通常更容易識別）
            return Math.random() > 0.2 ? mockResults[Math.floor(Math.random() * mockResults.length)] : null;
        }

        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'settings') {
                updateSettingsUI();
            }
        }

        function loadDemo() {
            // 載入示範數據到輸入框
            document.getElementById('barcodeInput').value = "RMSSD=52.4&pNN50=30&LF=615.2&HF=525.8&LFHF=1.2&SDNN=68.3";
    
            // 只有在QR Code模式下才顯示圖片
            if (currentInputMethod === 'qrcode') {
                const uploadArea = document.querySelector('#qrcode-input .upload-area');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="upload-content">
                            <img src="./demo-qr.png" alt="示範QR Code" style="max-width: 200px; max-height: 150px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">示範QR Code</div>
                            <div style="font-size: 0.8em; color: #059669;">✅ 已載入示範數據，點擊更換</div>
                        </div>
                    `;
                }
            }
    
            document.getElementById('status').textContent = '✅ 示範數據已載入';
            document.getElementById('status').className = 'success';
        }

        function clearInput() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('results').classList.remove('show');
    
            // 清除QR碼圖片預覽
            document.getElementById('qrcodePreview').innerHTML = '';
    
            // 重置檔案輸入
            document.getElementById('qrcodeFile').value = '';
    
            // 重置upload-area到原始狀態
            const uploadArea = document.querySelector('#qrcode-input .upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="upload-content">
                        <div class="upload-icon">📱</div>
                        <div>點擊上傳QR Code圖片</div>
                        <div class="upload-hint">支援 JPG, PNG, GIF 格式</div>
                    </div>
                `;
            }
    
            // 重置狀態
            const statusMessages = {
                manual: '✏️ 手動輸入模式',
                qrcode: '📱 QR Code掃描模式 - 請上傳圖片'
            };
    
            updateStatus(statusMessages[currentInputMethod] || '✏️ 手動輸入模式', '');
        }

        function isValidHRVData(inputValue) {
            if (!inputValue) return false;
            const requiredParams = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
            return requiredParams.every(param => inputValue.includes(param + '='));
        }

        function parseData(dataString) {
            const params = {};
            
            if (dataString.includes('hrv?') || dataString.includes('&')) {
                let cleanUrl = dataString;
                const hrvIndex = dataString.indexOf('hrv?');
                if (hrvIndex !== -1) {
                    cleanUrl = dataString.substring(hrvIndex + 4);
                } else {
                    const questionIndex = dataString.indexOf('?');
                    if (questionIndex !== -1) {
                        cleanUrl = dataString.substring(questionIndex + 1);
                    }
                }
                
                const urlParams = new URLSearchParams(cleanUrl);
                for (const [key, value] of urlParams) {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        params[key] = numValue;
                    }
                }
            }
            
            return params;
        }

        function analyzeData() {
            const inputValue = document.getElementById('barcodeInput').value.trim();
            
            if (!inputValue) {
                alert('請輸入數據！');
                return;
            }

            if (!isValidHRVData(inputValue)) {
                alert('❌ 數據格式錯誤！');
                return;
            }

            try {
                const params = parseData(inputValue);
                const requiredParams = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
                const missingParams = requiredParams.filter(param => !(param in params));
                
                if (missingParams.length > 0) {
                    alert(`❌ 缺少參數：${missingParams.join(', ')}`);
                    return;
                }
                
                displayParameters(params);
                const hrvGrading = performHRVGrading(params);
                displayAnalysis(hrvGrading);
                
                document.getElementById('results').classList.add('show');
                document.getElementById('status').textContent = '✅ 分析完成！';
                document.getElementById('status').className = 'success';
                
            } catch (error) {
                alert('❌ 數據處理錯誤！');
            }
        }

        function performHRVGrading(params) {
            if (!systemSettings.hrvGrading.enabled) return null;

            const rmssd = params.RMSSD || params.rMSSD;
            if (!rmssd) return null;

            // 第一步：找到所有符合rMSSD條件的級別
            const matchingGrades = [];
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade]) => {
                let matches = false;
        
                // 根據您的說明修正邊界判斷
                if (gradeId === 'grade1') {
                    matches = rmssd > 75;
                } else if (gradeId === 'grade2') {
                    matches = rmssd > 45 && rmssd <= 75;
                } else if (gradeId === 'grade3') {
                    matches = rmssd > 25 && rmssd <= 45;
                } else if (gradeId === 'grade4') {
                    matches = rmssd > 19 && rmssd <= 30;
                } else if (gradeId === 'grade5') {
                    matches = rmssd > 12 && rmssd <= 19;
                } else if (gradeId === 'grade6') {
                    matches = rmssd <= 12;
                }
        
                if (matches) {
                    matchingGrades.push({ 
                        id: gradeId, 
                        ...grade, 
                        gradeIndex: parseInt(gradeId.replace('grade', ''))
                    });
                }
            });

            if (matchingGrades.length === 0) return null;

            // rMSSD主要分級：如果有多個匹配，選擇第一個作為primary，其他作為overlapping
            matchingGrades.sort((a, b) => a.gradeIndex - b.gradeIndex); // 按級別排序
            const primaryGrade = matchingGrades[0];

            // rMSSD重疊情況：顯示所有匹配的級別
            const overlappingInfo = [];
            if (matchingGrades.length > 1) {
                const otherGrades = matchingGrades.slice(1);
                otherGrades.forEach(grade => {
                    overlappingInfo.push(`同時符合 ${grade.name}`);
                });
            }

            // 第二步：pNN50和LFHF補充說明 - 選擇較嚴重的級別
            const supplementaryInfo = [...overlappingInfo];

            if (params.pNN50 !== undefined) {
                const pnn50Grade = findParameterGrade('pNN50', params.pNN50); // 這個函數會選擇最嚴重的
                if (pnn50Grade && !matchingGrades.some(g => g.id === pnn50Grade.id)) {
                    supplementaryInfo.push(`pNN50 指向 ${pnn50Grade.name}`);
                }
            }

            if (params.LFHF !== undefined) {
                const lfhfGrade = findParameterGrade('LFHF', params.LFHF); // 這個函數會選擇最嚴重的
                if (lfhfGrade && !matchingGrades.some(g => g.id === lfhfGrade.id)) {
                    supplementaryInfo.push(`LF/HF 比值指向 ${lfhfGrade.name}`);
                }
            }

            return {
                primary: primaryGrade,
                supplementary: supplementaryInfo,
                confidence: calculateGradingConfidence(params, primaryGrade),
                allMatches: matchingGrades
            };
        }

        function findParameterGrade(paramName, value) {
            const matchingGrades = [];
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade]) => {
                const condition = grade.conditions[paramName];
                if (!condition) return;
        
                let matches = false;
        
                if (paramName === 'pNN50') {
                    // pNN50邊界判斷邏輯（選擇較嚴重的）
                    if (gradeId === 'grade1') {
                        matches = value > 30;
                    } else if (gradeId === 'grade2') {
                        matches = value > 15 && value <= 30;
                    } else if (gradeId === 'grade3') {
                        matches = value > 10 && value <= 20;
                    } else if (gradeId === 'grade4') {
                        matches = value > 6 && value <= 10;
                    } else if (gradeId === 'grade5') {
                        matches = value > 3 && value <= 6;
                    } else if (gradeId === 'grade6') {
                        matches = value <= 3;
                    }
                } else if (paramName === 'LFHF') {
                    // LFHF邊界判斷邏輯（選擇較嚴重的）
                    if (gradeId === 'grade1') {
                        matches = value > 0.3 && value <= 0.8;
                    } else if (gradeId === 'grade2') {
                        matches = value > 0.8 && value <= 2.0;
                    } else if (gradeId === 'grade3') {
                        matches = value > 1.5 && value <= 3.0;
                    } else if (gradeId === 'grade4') {
                        matches = value > 2.5 && value <= 4.0;
                    } else if (gradeId === 'grade5') {
                        matches = value > 3.5 && value <= 6.0;
                    } else if (gradeId === 'grade6') {
                        matches = value > 6.0 || value <= 0.3;
                    }
                } else {
                    // 其他參數保持原來的邏輯
                    if (Array.isArray(condition)) {
                        for (const range of condition) {
                            if (value >= range.min && value <= range.max) {
                                matches = true;
                                break;
                            }
                        }
                    } else {
                        matches = value >= condition.min && value <= condition.max;
                    }
                }
        
                if (matches) {
                    matchingGrades.push({ id: gradeId, ...grade, gradeIndex: parseInt(gradeId.replace('grade', '')) });
                }
            });

            // pNN50和LFHF：選擇較嚴重的級別（索引較大的）
            if (matchingGrades.length > 0) {
                matchingGrades.sort((a, b) => b.gradeIndex - a.gradeIndex);
                return matchingGrades[0];
            }
    
            return null;
        }

        function calculateGradingConfidence(params, primaryGrade) {
            let matchingParams = 0;
            let totalParams = 0;
            
            Object.entries(primaryGrade.conditions).forEach(([param, condition]) => {
                if (params[param] !== undefined) {
                    totalParams++;
            
                    if (Array.isArray(condition)) {
                        for (const range of condition) {
                            if (params[param] >= range.min && params[param] <= range.max) {
                                matchingParams++;
                                break;
                            }
                        }
                    } else {
                        if (params[param] >= condition.min && params[param] <= condition.max) {
                            matchingParams++;
                        }
                    }
                }
            });
    
            return totalParams > 0 ? (matchingParams / totalParams) * 100 : 0;
        }

        function displayParameters(params) {
            const container = document.getElementById('parameters');
            container.innerHTML = '';
            
            const parameterOrder = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
            
            parameterOrder.forEach(key => {
                if (params[key] !== undefined) {
                    const value = params[key];
                    const range = systemSettings.parameterRanges[key];
                    
                    let status = 'normal';
                    if (range && (value < range.min || value > range.max)) {
                        status = value < range.min ? 'warning' : 'danger';
                    }
                    
                    const card = document.createElement('div');
                    card.className = `param-card ${status}`;
                    card.innerHTML = `
                        <h4>${key}</h4>
                        <div class="value">${Number.isInteger(value) ? value : value.toFixed(1)}</div>
                    `;
                    
                    container.appendChild(card);
                }
            });
        }

        function displayAnalysis(hrvGrading = null) {
            const resultDiv = document.getElementById('analysisResult');
            const recommendationsDiv = document.getElementById('recommendationsList');

            if (hrvGrading && hrvGrading.primary) {
                resultDiv.innerHTML = `
                    <h3 style="color: ${hrvGrading.primary.color}; margin-bottom: 15px;">${hrvGrading.primary.name}</h3>
                    <p style="margin-bottom: 8px;"><strong>主要依據：</strong>rMSSD 值判斷</p>
                    ${hrvGrading.supplementary.length > 0 ? `<p style="font-size: 0.9em; color: #6b7280; margin-bottom: 8px;"><strong>補充說明：</strong>${hrvGrading.supplementary.join('、')}</p>` : ''}
                `;
        
                resultDiv.style.background = `${hrvGrading.primary.color}20`;
                resultDiv.style.borderLeft = `4px solid ${hrvGrading.primary.color}`;
            } else {
                resultDiv.innerHTML = `
                    <h3 style="color: #dc2626;">無法進行HRV分級</h3>
                    <p>請確認輸入的數據是否正確</p>
                `;
                resultDiv.style.background = '#fef2f2';
                resultDiv.style.borderLeft = '4px solid #dc2626';
            }

            recommendationsDiv.innerHTML = '';
            const recommendations = getRecommendations(hrvGrading);
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsDiv.appendChild(li);
            });
        }

        function getRecommendations(hrvGrading = null) {
            const recommendations = [];

            // 添加HRV分級的建議
            if (hrvGrading && hrvGrading.primary && hrvGrading.primary.recommendations) {
                hrvGrading.primary.recommendations.forEach(rec => {
                    if (rec.trim()) recommendations.push(rec);
                });
            }

            // 最後固定添加專業醫療建議
            recommendations.push('建議諮詢專業醫療人員');
            return recommendations;
        }

        function updateSettingsUI() {
            updateParameterRangesUI();
            updateHRVGradingUI();
        }

        function updateHRVGradingUI() {
            const classificationContainer = document.getElementById('classificationList');

            // 清空原有的分類列表內容
            classificationContainer.innerHTML = '';

            // 創建HRV分級設定來取代原有的分類列表
            const hrvGradingSection = document.createElement('div');
            hrvGradingSection.className = 'hrv-grading-section';
            hrvGradingSection.innerHTML = `
                <div id="hrvGradesList"></div>
            `;

            // 將HRV分級設定放入分類容器中
            classificationContainer.appendChild(hrvGradingSection);

            // 更新分級列表
            updateHRVGradesList();
        }

        function updateHRVGradesList() {
            const container = document.getElementById('hrvGradesList');
            if (!container) return;
    
            container.innerHTML = '';
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade], index) => {
                const gradeItem = document.createElement('div');
                gradeItem.className = 'classification-item hrv-grade-item';
                gradeItem.style.borderLeftColor = grade.color;
        
                gradeItem.innerHTML = `
                    <div class="classification-header">
                        <div><strong>級別 ${index + 1}</strong></div>
                    </div>
            
                    <div class="form-group">
                        <label>級別名稱：</label>
                        <input type="text" class="form-input" value="${grade.name}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>rMSSD 判斷範圍 (主要依據)：</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-input" value="${grade.rmssdRange.min}" 
                                onchange="updateHRVGradeRange('${gradeId}', 'min', this.value)" style="flex: 1;">
                            <span>-</span>
                            <input type="number" class="form-input" value="${grade.rmssdRange.max === Infinity ? '' : grade.rmssdRange.max}" 
                                placeholder="無上限" onchange="updateHRVGradeRange('${gradeId}', 'max', this.value)" style="flex: 1;">
                            <span>ms</span>
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">
                            注意：範圍判斷為 ${gradeId === 'grade1' ? '>最小值' : gradeId === 'grade6' ? '≤最大值' : '最小值 < 值 ≤ 最大值'}
                        </div>
                    </div>
            
                    <div class="form-group">
                        <label>其他參數範圍 (補充判斷)：</label>
                        <div class="parameter-ranges">
                            ${Object.entries(grade.conditions).map(([param, range]) => {
                                if (param === 'LFHF' && Array.isArray(range)) {
                                return `
                                    <div class="param-range">
                                        <strong>${param}:</strong> 
                                        ${range.map(r => `${r.min === 0 ? '<' : ''}${r.min === Infinity ? '>' : r.min}${r.max === Infinity ? '+' : '-' + r.max}`).join(' 或 ')}
                                    </div>
                                `;
                                } else {
                                    return `
                                        <div class="param-range">
                                            <strong>${param}:</strong> ${range.min}${range.max === Infinity ? '+' : '-' + range.max}
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
            
                    <div class="form-group">
                        <label>建議事項：</label>
                        <div class="suggestions-list">
                            ${grade.recommendations.map((rec, recIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${rec}" 
                                       onchange="updateHRVGradeRecommendation('${gradeId}', ${recIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeHRVGradeRecommendation('${gradeId}', ${recIndex})">移除</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addHRVGradeRecommendation('${gradeId}')">+ 新增建議</button>
                    </div>
                `;
        
                container.appendChild(gradeItem);
            });
        }

        function updateHRVGradeRange(gradeId, type, value) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade) {
                if (type === 'min') {
                    grade.rmssdRange.min = parseFloat(value) || 0;
                } else {
                    grade.rmssdRange.max = value === '' ? Infinity : parseFloat(value);
                }
            }
        }

        function updateHRVGradeRecommendation(gradeId, index, value) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade && grade.recommendations[index] !== undefined) {
                grade.recommendations[index] = value;
            }
        }

        function addHRVGradeRecommendation(gradeId) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade) {
                grade.recommendations.push('');
                updateHRVGradesList();
            }
        }

        function removeHRVGradeRecommendation(gradeId, index) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade && index >= 0) {
                grade.recommendations.splice(index, 1);
                updateHRVGradesList();
            }
        }

        function updateParameterRangesUI() {
    const container = document.getElementById('parameterRanges');
    container.innerHTML = '';
    
    Object.entries(systemSettings.parameterRanges).forEach(([param, range]) => {
        const div = document.createElement('div');
        div.className = 'range-input-group';
        div.dataset.param = param;
        
        // 檢查是否為手機版
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            div.innerHTML = `
                <div class="param-title">${param}</div>
                <div class="value-inputs">
                    <div class="input-group">
                        <div class="input-label">最小值</div>
                        <input type="number" class="range-input" value="${range.min}">
                    </div>
                    <div class="input-group">
                        <div class="input-label">最大值</div>
                        <input type="number" class="range-input" value="${range.max}">
                    </div>
                </div>
                <div class="description-input">
                    <div class="input-label">說明</div>
                    <input type="text" class="range-input" value="${range.description}">
                </div>
            `;
        } else {
            // 桌面版保持原來的格式
            div.innerHTML = `
                <label>${param}</label>
                <input type="number" class="range-input" value="${range.min}">
                <input type="number" class="range-input" value="${range.max}">
                <input type="text" class="range-input" value="${range.description}">
            `;
        }
        
        container.appendChild(div);
    });
}

        function updateClassificationUI() {
            const container = document.getElementById('classificationList');
            container.innerHTML = '';
            
            Object.entries(systemSettings.classificationRules).forEach(([type, rule], index) => {
                const item = document.createElement('div');
                item.className = `classification-item ${type}`;
                item.dataset.type = type;
                
                item.innerHTML = `
                    <div class="classification-header">
                        <div><strong>分類 ${index + 1}</strong></div>
                        <button class="delete-btn" onclick="deleteClassification('${type}')">刪除</button>
                    </div>
                    
                    <div class="form-group">
                        <label>分類名稱：</label>
                        <input type="text" class="form-input" value="${rule.name}" 
                               onchange="updateClassificationField('${type}', 'name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>描述（代表的狀況）：</label>
                        <textarea class="form-input form-textarea" 
                                  onchange="updateClassificationField('${type}', 'description', this.value)"
                                  placeholder="例如：個性容易緊張、工作壓力很大、生活步調緊湊的人">${rule.description || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>複合分類基準：</label>
                        <input type="text" class="form-input" value="${rule.condition}" 
                               onchange="updateClassificationField('${type}', 'condition', this.value)"
                               placeholder="例如：LFHF > 2.5">
                    </div>
                    
                    <div class="form-group">
                        <label>營養品補充建議：</label>
                        <div class="suggestions-list" data-type="${type}" data-list="supplements">
                            ${rule.supplements.map((item, itemIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${item}" 
                                           onchange="updateSuggestionItem('${type}', 'supplements', ${itemIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeSuggestionItem('${type}', 'supplements', ${itemIndex})">移除</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addSuggestionItem('${type}', 'supplements')">+ 新增營養品</button>
                    </div>
                    
                    <div class="form-group">
                        <label>生活改善建議：</label>
                        <div class="suggestions-list" data-type="${type}" data-list="lifestyle">
                            ${rule.lifestyle.map((item, itemIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${item}" 
                                           onchange="updateSuggestionItem('${type}', 'lifestyle', ${itemIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeSuggestionItem('${type}', 'lifestyle', ${itemIndex})">移除</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addSuggestionItem('${type}', 'lifestyle')">+ 新增建議</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function addNewClassification() {
            const existingTypes = Object.keys(systemSettings.classificationRules);
            let newTypeId = 'custom1';
            let counter = 1;
            
            while (existingTypes.includes(newTypeId)) {
                counter++;
                newTypeId = `custom${counter}`;
            }
            
            systemSettings.classificationRules[newTypeId] = {
                name: `自訂分類 ${counter}`,
                description: '',
                condition: '',
                supplements: [''],
                lifestyle: ['']
            };
            
            updateClassificationUI();
        }

        function deleteClassification(type) {
            if (confirm('確定要刪除這個分類嗎？')) {
                delete systemSettings.classificationRules[type];
                updateClassificationUI();
            }
        }

        function updateClassificationField(type, field, value) {
            if (systemSettings.classificationRules[type]) {
                systemSettings.classificationRules[type][field] = value;
            }
        }

        function addSuggestionItem(type, listType) {
            const rule = systemSettings.classificationRules[type];
            if (!rule || !rule[listType]) return;
            
            rule[listType].push('');
            updateClassificationUI();
        }

        function removeSuggestionItem(type, listType, index) {
            const rule = systemSettings.classificationRules[type];
            if (!rule || !rule[listType] || index < 0) return;
            
            rule[listType].splice(index, 1);
            updateClassificationUI();
        }

        function updateSuggestionItem(type, listType, index, value) {
            const rule = systemSettings.classificationRules[type];
            if (rule && rule[listType] && index >= 0) {
                rule[listType][index] = value;
            }
        }


function collectClassificationSettings() {
    const rules = {};
    const items = document.querySelectorAll('.classification-item[data-type]');
    
    items.forEach(item => {
        const type = item.dataset.type;
        const inputs = item.querySelectorAll('input, textarea');
        
        // 基本資訊
        const nameInput = item.querySelector('input[type="text"]');
        const descTextarea = item.querySelector('textarea');
        const conditionInputs = item.querySelectorAll('input[type="text"]');
        
        // 營養品建議
        const suppInputs = item.querySelectorAll('.suggestions-list[data-list="supplements"] input');
        const supplements = Array.from(suppInputs).map(i => i.value.trim()).filter(v => v);
        
        // 生活建議
        const lifeInputs = item.querySelectorAll('.suggestions-list[data-list="lifestyle"] input');
        const lifestyle = Array.from(lifeInputs).map(i => i.value.trim()).filter(v => v);
        
        rules[type] = {
            name: nameInput ? nameInput.value.trim() : '',
            description: descTextarea ? descTextarea.value.trim() : '',
            condition: conditionInputs[1] ? conditionInputs[1].value.trim() : '',
            supplements: supplements.length > 0 ? supplements : [''],
            lifestyle: lifestyle.length > 0 ? lifestyle : ['']
        };
    });
    
    return rules;
}

function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('hrvSystemSettings');
        if (savedSettings) {
            const parsedSettings = JSON.parse(savedSettings);
            
            // 合併設定，保留預設值作為備份
            if (parsedSettings.parameterRanges) {
                systemSettings.parameterRanges = {
                    ...systemSettings.parameterRanges,
                    ...parsedSettings.parameterRanges
                };
            }
            
            if (parsedSettings.classificationRules) {
                systemSettings.classificationRules = {
                    ...systemSettings.classificationRules,
                    ...parsedSettings.classificationRules
                };
            }
            
            console.log('設定已載入');
        }
    } catch (error) {
        console.error('載入設定失敗：', error);
        // 如果載入失敗，保持使用預設設定
    }
}

        function saveSettings() {
            const paramRanges = {};
            const rangeGroups = document.querySelectorAll('.range-input-group[data-param]');
            
            rangeGroups.forEach(elem => {
                const param = elem.dataset.param;
                const inputs = elem.querySelectorAll('input');
                
                paramRanges[param] = {
                    min: parseFloat(inputs[0].value) || 0,
                    max: parseFloat(inputs[1].value) || 100,
                    description: inputs[2].value || ''
                };
            });
            const classificationRules = collectClassificationSettings();

            systemSettings.parameterRanges = paramRanges;
            systemSettings.classificationRules = classificationRules;

                try {
        localStorage.setItem('hrvSystemSettings', JSON.stringify(systemSettings));
        alert('設定已儲存！');
    } catch (error) {
        console.error('儲存設定時發生錯誤：', error);
        alert('儲存失敗：' + error.message);
    }
}

        function resetToDefault() {
            if (confirm('確定要恢復預設設定嗎？')) {
                systemSettings.parameterRanges = {
                    'RMSSD': { min: 30, max: 100, description: '連續心跳間隔差異' },
                    'pNN50': { min: 10, max: 50, description: '心跳變異程度' },
                    'LF': { min: 300, max: 1500, description: '低頻功率' },
                    'HF': { min: 300, max: 1000, description: '高頻功率' },
                    'LFHF': { min: 0.5, max: 2.5, description: '自律神經平衡' },
                    'SDNN': { min: 50, max: 150, description: '心跳變異標準差' }
                };
                
                systemSettings.classificationRules = {
                    type1: { 
                        name: '類型一 - 交感神經過度活躍',
                        description: '個性容易緊張、工作壓力很大、生活步調緊湊的人',
                        condition: 'LFHF > 2.5',
                        supplements: ['穀維素', 'GABA'],
                        lifestyle: ['放鬆練習', '減少咖啡因', '深呼吸訓練']
                    },
                    type2: { 
                        name: '類型二 - 副交感神經過度活躍',
                        description: '活動量不足、缺乏運動的族群',
                        condition: 'LFHF < 0.5',
                        supplements: ['唐辛子', '人蔘皂甘'],
                        lifestyle: ['適度運動', '規律作息', '提升活力']
                    },
                    type3: { 
                        name: '類型三 - 多項指標異常',
                        description: '綜合性問題，需要全面性調理',
                        condition: '3個以上參數超出正常範圍',
                        supplements: ['唐辛子+穀維素', '人蔘皂甘+穀維素'],
                        lifestyle: ['就醫諮詢', '密切監控', '綜合調理']
                    },
                    normal: { 
                        name: '正常範圍',
                        description: '各項指標均在健康範圍內',
                        condition: '所有參數在正常範圍內',
                        supplements: ['維持現狀'],
                        lifestyle: ['保持良好習慣', '定期檢測']
                    }
                };
                
                updateSettingsUI();
                alert('已恢復預設設定！');
            }
        }

        // 系統初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
     
    document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            analyzeData();
        }
    });
    
    // 設置拖拽功能（僅限QR Code）
    setupDragAndDrop();
    
    // 初始化預設輸入方式
    updateStatus('✏️ 手動輸入模式', '');
    
    // 新增：響應式偵測，當視窗大小改變時重新渲染設定介面
    window.addEventListener('resize', function() {
        if (document.getElementById('parameterRanges').innerHTML !== '') {
            updateParameterRangesUI();
        }
    });
});
    </script>
</body>
</html>
