<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRVå ±å‘Šæƒæåˆ†æç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #374151; font-size: 1.8em; margin-bottom: 10px; }
        .header p { color: #6b7280; }
        
        .nav-tabs {
            display: flex;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            background: #f9fafb;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
        }
        .nav-tab.active { background: white; color: #374151; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .scan-section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .barcode-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1.1em;
            margin: 15px 0;
        }
        
        .scan-btn {
            background: #6b7280;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 1em;
        }
        .scan-btn:hover { background: #4b5563; }
        .demo-btn { background: #10b981; }
        .demo-btn:hover { background: #059669; }
        
        #status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            background: #f3f4f6;
            color: #6b7280;
        }
        #status.success { background: #dcfce7; color: #166534; }
        #status.error { background: #fef2f2; color: #dc2626; }
        
        .results {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-top: 20px;
        }
        .results.show { display: block; }
        
        .parameters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .param-card {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .param-card h4 { color: #374151; margin-bottom: 10px; }
        .param-card .value { font-size: 1.8em; font-weight: bold; color: #111827; }
        .param-card .unit { font-size: 0.8em; color: #6b7280; }
        .param-card.normal .value { color: #10b981; }  /* ç¶ è‰²æ–‡å­— */
        .param-card.warning .value { color: #f59e0b; } /* é»ƒè‰²æ–‡å­— */
        .param-card.danger .value { color: #ef4444; }  /* ç´…è‰²æ–‡å­— */
        
        .analysis-result {
            background: #f3f4f6;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .analysis-result h3 { font-size: 1.3em; margin-bottom: 10px; }
        
        .recommendations {
            background: #fafafa;
            padding: 20px;
            border-radius: 8px;
        }
        .recommendations h4 { margin-bottom: 15px; color: #374151; }
        .recommendations ul { list-style: none; }
        .recommendations li {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
        }
        .recommendations li:before { content: "â€¢ "; color: #10b981; font-weight: bold; }
        
        .settings-section { margin-bottom: 30px; }
        .settings-section h3 {
            color: #374151;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .range-input-group {
            display: grid;
            grid-template-columns: 1fr 100px 100px 150px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .range-input { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
        
        .classification-section { margin-bottom: 30px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        .add-classification-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
        }
        
        .classification-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .classification-item.type1 { border-left: 4px solid #f59e0b; }
        .classification-item.type2 { border-left: 4px solid #f59e0b; }
        .classification-item.type3 { border-left: 4px solid #ef4444; }
        .classification-item.normal { border-left: 4px solid #10b981; }
        .classification-item.custom1,
        .classification-item.custom2,
        .classification-item.custom3 { border-left: 4px solid #6366f1; }
        
        .classification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #6b7280; }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        
        .suggestions-list { margin-top: 10px; }
        .suggestion-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .suggestion-input { flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .remove-btn {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
        }
        .add-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .save-btn {
            background: #10b981;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .reset-btn { background: #ef4444; }
        
        .disclaimer {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            color: #7f1d1d;
            text-align: center;
        }

        /* æ–°å¢æ¨£å¼ */
        .input-method-tabs {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #d1d5db;
        }
        .method-tab {
            flex: 1;
            padding: 12px;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
            border-radius: 8px;
        }
        .method-tab.active { background: #10b981; color: white; }
        .method-tab:hover { background: #e5e7eb; }
        .method-tab.active:hover { background: #059669; }

        .input-section { display: none; margin: 15px 0; }
        .input-section.active { display: block; }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
            margin: 15px 0;
        }
        .upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .upload-area.dragover {
            border-color: #10b981;
            background: #dcfce7;
        }

        .upload-content {
            color: #6b7280;
        }
        .upload-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .upload-hint {
            font-size: 0.9em;
            color: #9ca3af;
            margin-top: 5px;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .preview-info {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 0.9em;
            color: #6b7280;
        }

        .processing-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            background: #fffbeb;
            border: 1px solid #fde68a;
            color: #92400e;
            text-align: center;
        }
        .processing-status.success {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }
        .processing-status.error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }
    
        /* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .container {
        padding: 10px;
        margin: 10px;
    }
    
    /* æˆ–è€…æ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ï¼Œéš±è—åŒ…å«æ¨™é¡Œçš„é‚£ä¸€è¡Œ */
    .range-input-group:not([data-param]) {
        display: none !important;
    }

    .range-input-group {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
    }
    
    /* åƒæ•¸åç¨±æ¨™é¡Œ */
    .param-title {
        font-size: 1.1em;
        font-weight: bold;
        color: #374151;
        margin-bottom: 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    /* æ•¸å€¼è¼¸å…¥å€åŸŸ */
    .value-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .input-label {
        font-size: 0.85em;
        font-weight: 600;
        color: #6b7280;
    }
    
    .range-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1em;
        text-align: center;
    }
    
    /* èªªæ˜è¼¸å…¥å€åŸŸ */
    .description-input {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .description-input .range-input {
        text-align: left;
        font-size: 0.9em;
    }
    
    .range-input:focus {
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
}
    
    .range-input-group label {
        font-weight: bold;
        color: #374151;
        margin-bottom: 5px;
    }
    
    .range-input {
        width: 100%;
        padding: 10px;
    }
    
    /* åƒæ•¸å¡ç‰‡ä¹Ÿè¦èª¿æ•´ */
    .parameters {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
    }
    
    .param-card {
        padding: 12px;
    }
    
    /* å»ºè­°åˆ—è¡¨èª¿æ•´ */
    .suggestion-item {
        flex-direction: column;
        gap: 5px;
    }
    
    .remove-btn {
        align-self: flex-start;
        width: fit-content;
    }
    
    /* æŒ‰éˆ•èª¿æ•´ */
    .scan-btn {
        padding: 12px 20px;
        margin: 3px;
        font-size: 0.9em;
    }
    
    /* åˆ†é¡é …ç›®èª¿æ•´ */
    .classification-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    /* ç‹€æ…‹é¡¯ç¤ºèª¿æ•´ */
    #status {
        font-size: 0.9em;
        padding: 10px;
    }

@media (max-width: 480px) {
    .header h1 {
        font-size: 1.5em;
    }
    
    .nav-tab {
        padding: 12px 8px;
        font-size: 0.9em;
    }
    
    .parameters {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    
    .scan-section {
        padding: 15px;
    }
}

/* åœ¨é€™è£¡æ–°å¢HRVåˆ†ç´šç›¸é—œçš„CSS */
.hrv-grading-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.toggle-label {
    font-weight: 600;
    color: #374151;
}

.grading-info {
    background: #fffbeb;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 4px solid #f59e0b;
}

.grading-info ol {
    margin-left: 20px;
    color: #92400e;
}

.hrv-grade-item {
    border-left: 4px solid #6366f1 !important;
}

.parameter-ranges {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.param-range {
    background: #f9fafb;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.9em;
    border: 1px solid #e5e7eb;
}

/* åœ¨é€™è£¡æ–°å¢HRVåˆ†ç´šçµæœçš„æ¨£å¼ */
.hrv-grading-result {
    margin: 15px 0;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid;
}

.hrv-grading-result h4 {
    margin-bottom: 10px;
    font-size: 1.1em;
}

.hrv-grading-result p {
    margin-bottom: 5px;
    line-height: 1.4;
}

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ HRVå ±å‘Šæƒæåˆ†æç³»çµ±</h1>
            <p>æƒæå ±å‘Šä¸Šçš„QR Codeï¼Œç«‹å³ç²å¾—å€‹äººåŒ–åˆ†æçµæœ</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('scanner')">ğŸ“± æƒæåˆ†æ</button>
            <button class="nav-tab" onclick="switchTab('settings')">âš™ï¸ è‡ªè¨‚è¨­å®š</button>
        </div>

        <div id="scanner-tab" class="tab-content active">
            <div class="scan-section">
                <label>ğŸ” é¸æ“‡æƒææ–¹å¼ï¼š</label>
                
                <!-- è¼¸å…¥æ–¹å¼é¸æ“‡ -->
                <div class="input-method-tabs">
                    <button class="method-tab active" onclick="switchInputMethod('manual')">âœï¸ æ‰‹å‹•è¼¸å…¥</button>
                    <button class="method-tab" onclick="switchInputMethod('qrcode')">ğŸ“± QR Codeæƒæ</button>
                </div>

                <!-- æ‰‹å‹•è¼¸å…¥å€åŸŸ -->
                <div id="manual-input" class="input-section active">
                    <label>è«‹è¼¸å…¥HRVæ•¸æ“šï¼š</label>
                    <input type="text" id="barcodeInput" class="barcode-input" 
                           placeholder="ç¯„ä¾‹ï¼šRMSSD=52.4&pNN50=30&LF=615.2&HF=525.8&LFHF=1.2&SDNN=68.3">
                </div>

                <!-- QR Codeä¸Šå‚³å€åŸŸ -->
                <div id="qrcode-input" class="input-section">
                    <label>ä¸Šå‚³QR Codeåœ–ç‰‡ï¼š</label>
                    <div class="upload-area" onclick="document.getElementById('qrcodeFile').click()">
                        <div class="upload-content">
                            <div class="upload-icon">ğŸ“±</div>
                            <div>é»æ“Šä¸Šå‚³QR Codeåœ–ç‰‡</div>
                            <div class="upload-hint">æ”¯æ´ JPG, PNG, GIF æ ¼å¼</div>
                        </div>
                    </div>
                    <input type="file" id="qrcodeFile" accept="image/*" style="display: none;" onchange="processQRCodeImage(this)">
                    <div id="qrcodePreview" class="image-preview"></div>
                </div>

                <div id="status">âœï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼</div>
                
                <button class="scan-btn" onclick="analyzeData()">ğŸ” åˆ†æå ±å‘Š</button>
                <button class="scan-btn demo-btn" onclick="loadDemo()">ğŸ“‹ è¼‰å…¥ç¤ºç¯„æ•¸æ“š</button>
                <button class="scan-btn" onclick="clearInput()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>

            <div id="results" class="results">
                <div class="result-header">
                    <h2 style="margin-bottom: 20px; line-height: 1.1;">ğŸ“Š åˆ†æçµæœ</h2>
        <p style="margin-bottom: 25px; line-height: 1;">åŸºæ–¼æ‚¨çš„HRVåƒæ•¸é€²è¡Œçš„è‡ªå¾‹ç¥ç¶“åŠŸèƒ½è©•ä¼°</p>
                </div>
                <div id="parameters" class="parameters"></div>
                <div id="analysisResult" class="analysis-result"></div>
                <div class="recommendations">
                    <h4>ğŸ’¡ å€‹äººåŒ–å»ºè­°</h4>
                    <ul id="recommendationsList"></ul>
                </div>
                <div class="disclaimer">
                    <strong>âš ï¸ é‡è¦è²æ˜ï¼š</strong>
                    æœ¬åˆ†æçµæœåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆé†«ç™‚è¨ºæ–·ã€‚å¦‚æœ‰å¥åº·ç–‘æ…®ï¼Œè«‹è«®è©¢å°ˆæ¥­é†«ç™‚äººå“¡ã€‚
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="settings-section">
                <h3>ğŸ“Š HRVåƒæ•¸æ­£å¸¸ç¯„åœè¨­å®š</h3>
                <div class="range-input-group">
                    <label>åƒæ•¸åç¨±</label>
                    <label>æœ€å°å€¼</label>
                    <label>æœ€å¤§å€¼</label>
                    <label>èªªæ˜</label>
                </div>
                <div id="parameterRanges"></div>
            </div>

            <div class="classification-section">
                <div class="section-header">
                    <h3>ğŸ·ï¸ åˆ†é¡æ¨™æº–èˆ‡å»ºè­°è¨­å®š</h3>
                </div>
                <div id="classificationList"></div>
            </div>

            <div class="settings-section">
                <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button class="save-btn reset-btn" onclick="resetToDefault()">ğŸ”„ æ¢å¾©é è¨­</button>
            </div>
        </div>
    </div>

    <script>
        let systemSettings = {
            parameterRanges: {
                'RMSSD': { min: 30, max: 100, description: 'é€£çºŒå¿ƒè·³é–“éš”å·®ç•°' },
                'pNN50': { min: 10, max: 50, description: 'å¿ƒè·³è®Šç•°ç¨‹åº¦' },
                'LF': { min: 300, max: 1500, description: 'ä½é »åŠŸç‡' },
                'HF': { min: 300, max: 1000, description: 'é«˜é »åŠŸç‡' },
                'LFHF': { min: 0.5, max: 2.5, description: 'è‡ªå¾‹ç¥ç¶“å¹³è¡¡' },
                'SDNN': { min: 50, max: 150, description: 'å¿ƒè·³è®Šç•°æ¨™æº–å·®' }
            },
            classificationRules: {
                type1: { 
                    name: 'é¡å‹ä¸€ - äº¤æ„Ÿç¥ç¶“éåº¦æ´»èº',
                    description: 'å€‹æ€§å®¹æ˜“ç·Šå¼µã€å·¥ä½œå£“åŠ›å¾ˆå¤§ã€ç”Ÿæ´»æ­¥èª¿ç·Šæ¹Šçš„äºº',
                    condition: 'LFHF > 2.5',
                    supplements: ['ç©€ç¶­ç´ ', 'GABA'],
                    lifestyle: ['æ”¾é¬†ç·´ç¿’', 'æ¸›å°‘å’–å•¡å› ', 'æ·±å‘¼å¸è¨“ç·´']
                },
                type2: { 
                    name: 'é¡å‹äºŒ - å‰¯äº¤æ„Ÿç¥ç¶“éåº¦æ´»èº',
                    description: 'æ´»å‹•é‡ä¸è¶³ã€ç¼ºä¹é‹å‹•çš„æ—ç¾¤',
                    condition: 'LFHF < 0.5',
                    supplements: ['å”è¾›å­', 'äººè”˜çš‚ç”˜'],
                    lifestyle: ['é©åº¦é‹å‹•', 'è¦å¾‹ä½œæ¯', 'æå‡æ´»åŠ›']
                },
                type3: { 
                    name: 'é¡å‹ä¸‰ - å¤šé …æŒ‡æ¨™ç•°å¸¸',
                    description: 'ç¶œåˆæ€§å•é¡Œï¼Œéœ€è¦å…¨é¢æ€§èª¿ç†',
                    condition: '3å€‹ä»¥ä¸Šåƒæ•¸è¶…å‡ºæ­£å¸¸ç¯„åœ',
                    supplements: ['å”è¾›å­+ç©€ç¶­ç´ ', 'äººè”˜çš‚ç”˜+ç©€ç¶­ç´ '],
                    lifestyle: ['å°±é†«è«®è©¢', 'å¯†åˆ‡ç›£æ§', 'ç¶œåˆèª¿ç†']
                },
                normal: { 
                    name: 'æ­£å¸¸ç¯„åœ',
                    description: 'å„é …æŒ‡æ¨™å‡åœ¨å¥åº·ç¯„åœå…§',
                    condition: 'æ‰€æœ‰åƒæ•¸åœ¨æ­£å¸¸ç¯„åœå…§',
                    supplements: ['ç¶­æŒç¾ç‹€'],
                    lifestyle: ['ä¿æŒè‰¯å¥½ç¿’æ…£', 'å®šæœŸæª¢æ¸¬']
                }
            },
            hrvGrading: {
                enabled: true,
                grades: {
                    grade1: {
                        name: 'æ¥µä½³æ¢å¾©ç‹€æ³',
                        rmssdRange: { min: 75, max: Infinity },
                        conditions: {
                             LFHF: { min: 0.3, max: 0.8 },
                             pNN50: { min: 30, max: Infinity }
                        },
                        color: '#10b981',
                        recommendations: ['ç¶­æŒç¾æœ‰ç”Ÿæ´»å‹æ…‹', 'å®šæœŸç›£æ¸¬ä¿æŒç‹€æ…‹']
                    },
                    grade2: {
                        name: 'è‰¯å¥½å¹³è¡¡ç‹€æ³',
                        rmssdRange: { min: 45, max: 75 },
                        conditions: {
                            LFHF: { min: 0.8, max: 2.0 },
                            pNN50: { min: 15, max: 30 }
                         },
                        color: '#22c55e',
                        recommendations: ['ä¿æŒè¦å¾‹é‹å‹•', 'ç¶­æŒè‰¯å¥½ç¡çœ å“è³ª']
                    },
                    grade3: {
                        name: 'è¼•åº¦ç–²å‹ç‹€æ…‹',
                        rmssdRange: { min: 25, max: 45 },
                        conditions: {
                            LFHF: { min: 1.5, max: 3.0 },
                            pNN50: { min: 10, max: 20 }
                        },
                        color: '#eab308',
                        recommendations: ['é©åº¦ä¼‘æ¯èª¿æ•´', 'æ³¨æ„å£“åŠ›ç®¡ç†', 'æ”¹å–„ç¡çœ å“è³ª']
                    },
                    grade4: {
                        name: 'ä¸­åº¦å£“åŠ›ç‹€æ…‹',
                        rmssdRange: { min: 19, max: 30 },
                        conditions: {
                            LFHF: { min: 2.5, max: 4.0 },
                            pNN50: { min: 6, max: 10 }
                        },
                        color: '#f59e0b',
                        recommendations: ['éœ€è¦å……åˆ†ä¼‘æ¯', 'å»ºè­°æ¸›å°‘å·¥ä½œå£“åŠ›', 'é€²è¡Œæ”¾é¬†è¨“ç·´']
                    },
                    grade5: {
                        name: 'é«˜åº¦å£“åŠ›ç‹€æ…‹',
                        rmssdRange: { min: 12, max: 19 },
                        conditions: {
                            LFHF: { min: 3.5, max: 6.0 },
                            pNN50: { min: 3, max: 6 }
                        },
                        color: '#ef4444',
                        recommendations: ['ç«‹å³ä¼‘æ¯èª¿æ•´', 'å°‹æ±‚å°ˆæ¥­å”åŠ©', 'é‡æ–°è©•ä¼°ç”Ÿæ´»å‹æ…‹']
                    },
                    grade6: {
                        name: 'æ¥µåº¦å£“åŠ›ç‹€æ…‹',
                        rmssdRange: { min: 0, max: 12 },
                        conditions: {
                            LFHF: [{ min: 6.0, max: Infinity }, { min: 0, max: 0.3 }],
                            pNN50: { min: 0, max: 3 }
                        },
                        color: '#dc2626',
                        recommendations: ['ç·Šæ€¥ä¼‘æ¯', 'ç«‹å³å°±é†«è«®è©¢', 'å…¨é¢ç”Ÿæ´»å‹æ…‹èª¿æ•´']
                    }
                }
            }
        };

        let currentInputMethod = 'manual';

        function switchInputMethod(method) {
            currentInputMethod = method;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°è¼¸å…¥å€åŸŸé¡¯ç¤º
            document.querySelectorAll('.input-section').forEach(section => section.classList.remove('active'));
            document.getElementById(method + '-input').classList.add('active');
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            const statusMessages = {
                manual: 'âœï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼',
                qrcode: 'ğŸ“± QR Codeæƒææ¨¡å¼ - è«‹ä¸Šå‚³åœ–ç‰‡'
            };
            
            document.getElementById('status').textContent = statusMessages[method];
            document.getElementById('status').className = '';
        }

function processQRCodeImage(input) {
    const file = input.files[0];
    if (!file) return;
    
    updateStatus('ğŸ”„ æ­£åœ¨è™•ç†QR Codeåœ–ç‰‡...', 'processing');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // ç›´æ¥æ›´æ–° upload-area çš„å…§å®¹
            const uploadArea = document.querySelector('#qrcode-input .upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="upload-content">
                        <img src="${img.src}" alt="QR Codeé è¦½" style="max-width: 200px; max-height: 150px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">${file.name}</div>
                        <div style="font-size: 0.8em; color: #9ca3af;">æ­£åœ¨è­˜åˆ¥ä¸­...</div>
                    </div>
                `;
            }
            
            // æ¨¡æ“¬QRç¢¼è­˜åˆ¥éç¨‹
            setTimeout(() => {
                const mockQRData = simulateQRCodeReading(file.name);
                if (mockQRData) {
                    document.getElementById('barcodeInput').value = mockQRData;
                    updateStatus('âœ… QR Codeè®€å–æˆåŠŸï¼', 'success');
                    
                    // æ›´æ–°upload-areaçš„ç‹€æ…‹æç¤º
                    if (uploadArea) {
                        const hintDiv = uploadArea.querySelector('.upload-content div:last-child');
                        if (hintDiv) {
                            hintDiv.textContent = 'âœ… å·²è®€å–æˆåŠŸï¼Œé»æ“Šæ›´æ›';
                            hintDiv.style.color = '#059669';
                        }
                    }
                } else {
                    updateStatus('âŒ ç„¡æ³•è­˜åˆ¥QR Codeï¼Œè«‹å˜—è©¦å…¶ä»–åœ–ç‰‡', 'error');
                    
                    // æ›´æ–°upload-areaçš„ç‹€æ…‹æç¤º
                    if (uploadArea) {
                        const hintDiv = uploadArea.querySelector('.upload-content div:last-child');
                        if (hintDiv) {
                            hintDiv.textContent = 'âŒ ç„¡æ³•è­˜åˆ¥ï¼Œé»æ“Šé‡æ–°ä¸Šå‚³';
                            hintDiv.style.color = '#dc2626';
                        }
                    }
                }
            }, 2000);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// åœ¨é€™è£¡æ–°å¢ setupDragAndDrop å‡½æ•¸
function setupDragAndDrop() {
    const uploadAreas = document.querySelectorAll('.upload-area');
    
    uploadAreas.forEach(area => {
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    if (area.closest('#qrcode-input')) {
                        processQRCodeImage({ files: [file] });
                    }
                }
            }
        });
    });
}

        function displayImagePreview(containerId, imageSrc, fileName) {
            // é€™å€‹å‡½æ•¸ç¾åœ¨ç”± processQRCodeImage ç›´æ¥è™•ç†
            // ä¿ç•™ç©ºå‡½æ•¸é¿å…éŒ¯èª¤
        }

        function simulateQRCodeReading(fileName) {
            // æ¨¡æ“¬ä¸åŒçš„QRç¢¼è­˜åˆ¥çµæœ
            const mockResults = [
                "https://hospital.com/report?RMSSD=41.7&pNN50=22&LF=685.4&HF=445.9&LFHF=1.8&SDNN=71.2",
                "https://clinic.com/hrv-data?RMSSD=55.1&pNN50=35&LF=590.8&HF=580.3&LFHF=1.0&SDNN=82.6",
                "https://health.com/analysis?RMSSD=33.8&pNN50=15&LF=950.2&HF=285.4&LFHF=3.3&SDNN=58.9"
            ];
            
            // æ ¹æ“šæª”åç‰¹æ€§æ±ºå®šæ˜¯å¦æˆåŠŸè­˜åˆ¥
            if (fileName.toLowerCase().includes('qr') || fileName.toLowerCase().includes('code')) {
                return mockResults[Math.floor(Math.random() * mockResults.length)];
            }
            
            // 80% æ©Ÿç‡æˆåŠŸè­˜åˆ¥ï¼ˆQRç¢¼é€šå¸¸æ›´å®¹æ˜“è­˜åˆ¥ï¼‰
            return Math.random() > 0.2 ? mockResults[Math.floor(Math.random() * mockResults.length)] : null;
        }

        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'settings') {
                updateSettingsUI();
            }
        }

        function loadDemo() {
            // è¼‰å…¥ç¤ºç¯„æ•¸æ“šåˆ°è¼¸å…¥æ¡†
            document.getElementById('barcodeInput').value = "RMSSD=52.4&pNN50=30&LF=615.2&HF=525.8&LFHF=1.2&SDNN=68.3";
    
            // åªæœ‰åœ¨QR Codeæ¨¡å¼ä¸‹æ‰é¡¯ç¤ºåœ–ç‰‡
            if (currentInputMethod === 'qrcode') {
                const uploadArea = document.querySelector('#qrcode-input .upload-area');
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <div class="upload-content">
                            <img src="./demo-qr.png" alt="ç¤ºç¯„QR Code" style="max-width: 200px; max-height: 150px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="font-size: 0.9em; color: #6b7280; margin-bottom: 5px;">ç¤ºç¯„QR Code</div>
                            <div style="font-size: 0.8em; color: #059669;">âœ… å·²è¼‰å…¥ç¤ºç¯„æ•¸æ“šï¼Œé»æ“Šæ›´æ›</div>
                        </div>
                    `;
                }
            }
    
            document.getElementById('status').textContent = 'âœ… ç¤ºç¯„æ•¸æ“šå·²è¼‰å…¥';
            document.getElementById('status').className = 'success';
        }

        function clearInput() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('results').classList.remove('show');
    
            // æ¸…é™¤QRç¢¼åœ–ç‰‡é è¦½
            document.getElementById('qrcodePreview').innerHTML = '';
    
            // é‡ç½®æª”æ¡ˆè¼¸å…¥
            document.getElementById('qrcodeFile').value = '';
    
            // é‡ç½®upload-areaåˆ°åŸå§‹ç‹€æ…‹
            const uploadArea = document.querySelector('#qrcode-input .upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="upload-content">
                        <div class="upload-icon">ğŸ“±</div>
                        <div>é»æ“Šä¸Šå‚³QR Codeåœ–ç‰‡</div>
                        <div class="upload-hint">æ”¯æ´ JPG, PNG, GIF æ ¼å¼</div>
                    </div>
                `;
            }
    
            // é‡ç½®ç‹€æ…‹
            const statusMessages = {
                manual: 'âœï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼',
                qrcode: 'ğŸ“± QR Codeæƒææ¨¡å¼ - è«‹ä¸Šå‚³åœ–ç‰‡'
            };
    
            updateStatus(statusMessages[currentInputMethod] || 'âœï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼', '');
        }

        function isValidHRVData(inputValue) {
            if (!inputValue) return false;
            const requiredParams = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
            return requiredParams.every(param => inputValue.includes(param + '='));
        }

        function parseData(dataString) {
            const params = {};
            
            if (dataString.includes('hrv?') || dataString.includes('&')) {
                let cleanUrl = dataString;
                const hrvIndex = dataString.indexOf('hrv?');
                if (hrvIndex !== -1) {
                    cleanUrl = dataString.substring(hrvIndex + 4);
                } else {
                    const questionIndex = dataString.indexOf('?');
                    if (questionIndex !== -1) {
                        cleanUrl = dataString.substring(questionIndex + 1);
                    }
                }
                
                const urlParams = new URLSearchParams(cleanUrl);
                for (const [key, value] of urlParams) {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        params[key] = numValue;
                    }
                }
            }
            
            return params;
        }

        function analyzeData() {
            const inputValue = document.getElementById('barcodeInput').value.trim();
            
            if (!inputValue) {
                alert('è«‹è¼¸å…¥æ•¸æ“šï¼');
                return;
            }

            if (!isValidHRVData(inputValue)) {
                alert('âŒ æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼');
                return;
            }

            try {
                const params = parseData(inputValue);
                const requiredParams = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
                const missingParams = requiredParams.filter(param => !(param in params));
                
                if (missingParams.length > 0) {
                    alert(`âŒ ç¼ºå°‘åƒæ•¸ï¼š${missingParams.join(', ')}`);
                    return;
                }
                
                displayParameters(params);
                const hrvGrading = performHRVGrading(params);
                displayAnalysis(hrvGrading);
                
                document.getElementById('results').classList.add('show');
                document.getElementById('status').textContent = 'âœ… åˆ†æå®Œæˆï¼';
                document.getElementById('status').className = 'success';
                
            } catch (error) {
                alert('âŒ æ•¸æ“šè™•ç†éŒ¯èª¤ï¼');
            }
        }

        function performHRVGrading(params) {
            if (!systemSettings.hrvGrading.enabled) return null;

            const rmssd = params.RMSSD || params.rMSSD;
            if (!rmssd) return null;

            // ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°æ‰€æœ‰ç¬¦åˆrMSSDæ¢ä»¶çš„ç´šåˆ¥
            const matchingGrades = [];
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade]) => {
                let matches = false;
        
                // æ ¹æ“šæ‚¨çš„èªªæ˜ä¿®æ­£é‚Šç•Œåˆ¤æ–·
                if (gradeId === 'grade1') {
                    matches = rmssd > 75;
                } else if (gradeId === 'grade2') {
                    matches = rmssd > 45 && rmssd <= 75;
                } else if (gradeId === 'grade3') {
                    matches = rmssd > 25 && rmssd <= 45;
                } else if (gradeId === 'grade4') {
                    matches = rmssd > 19 && rmssd <= 30;
                } else if (gradeId === 'grade5') {
                    matches = rmssd > 12 && rmssd <= 19;
                } else if (gradeId === 'grade6') {
                    matches = rmssd <= 12;
                }
        
                if (matches) {
                    matchingGrades.push({ 
                        id: gradeId, 
                        ...grade, 
                        gradeIndex: parseInt(gradeId.replace('grade', ''))
                    });
                }
            });

            if (matchingGrades.length === 0) return null;

            // rMSSDä¸»è¦åˆ†ç´šï¼šå¦‚æœæœ‰å¤šå€‹åŒ¹é…ï¼Œé¸æ“‡ç¬¬ä¸€å€‹ä½œç‚ºprimaryï¼Œå…¶ä»–ä½œç‚ºoverlapping
            matchingGrades.sort((a, b) => a.gradeIndex - b.gradeIndex); // æŒ‰ç´šåˆ¥æ’åº
            const primaryGrade = matchingGrades[0];

            // rMSSDé‡ç–Šæƒ…æ³ï¼šé¡¯ç¤ºæ‰€æœ‰åŒ¹é…çš„ç´šåˆ¥
            const overlappingInfo = [];
            if (matchingGrades.length > 1) {
                const otherGrades = matchingGrades.slice(1);
                otherGrades.forEach(grade => {
                    overlappingInfo.push(`åŒæ™‚ç¬¦åˆ ${grade.name}`);
                });
            }

            // ç¬¬äºŒæ­¥ï¼špNN50å’ŒLFHFè£œå……èªªæ˜ - é¸æ“‡è¼ƒåš´é‡çš„ç´šåˆ¥
            const supplementaryInfo = [...overlappingInfo];

            if (params.pNN50 !== undefined) {
                const pnn50Grade = findParameterGrade('pNN50', params.pNN50); // é€™å€‹å‡½æ•¸æœƒé¸æ“‡æœ€åš´é‡çš„
                if (pnn50Grade && !matchingGrades.some(g => g.id === pnn50Grade.id)) {
                    supplementaryInfo.push(`pNN50 æŒ‡å‘ ${pnn50Grade.name}`);
                }
            }

            if (params.LFHF !== undefined) {
                const lfhfGrade = findParameterGrade('LFHF', params.LFHF); // é€™å€‹å‡½æ•¸æœƒé¸æ“‡æœ€åš´é‡çš„
                if (lfhfGrade && !matchingGrades.some(g => g.id === lfhfGrade.id)) {
                    supplementaryInfo.push(`LF/HF æ¯”å€¼æŒ‡å‘ ${lfhfGrade.name}`);
                }
            }

            return {
                primary: primaryGrade,
                supplementary: supplementaryInfo,
                confidence: calculateGradingConfidence(params, primaryGrade),
                allMatches: matchingGrades
            };
        }

        function findParameterGrade(paramName, value) {
            const matchingGrades = [];
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade]) => {
                const condition = grade.conditions[paramName];
                if (!condition) return;
        
                let matches = false;
        
                if (paramName === 'pNN50') {
                    // pNN50é‚Šç•Œåˆ¤æ–·é‚è¼¯ï¼ˆé¸æ“‡è¼ƒåš´é‡çš„ï¼‰
                    if (gradeId === 'grade1') {
                        matches = value > 30;
                    } else if (gradeId === 'grade2') {
                        matches = value > 15 && value <= 30;
                    } else if (gradeId === 'grade3') {
                        matches = value > 10 && value <= 20;
                    } else if (gradeId === 'grade4') {
                        matches = value > 6 && value <= 10;
                    } else if (gradeId === 'grade5') {
                        matches = value > 3 && value <= 6;
                    } else if (gradeId === 'grade6') {
                        matches = value <= 3;
                    }
                } else if (paramName === 'LFHF') {
                    // LFHFé‚Šç•Œåˆ¤æ–·é‚è¼¯ï¼ˆé¸æ“‡è¼ƒåš´é‡çš„ï¼‰
                    if (gradeId === 'grade1') {
                        matches = value > 0.3 && value <= 0.8;
                    } else if (gradeId === 'grade2') {
                        matches = value > 0.8 && value <= 2.0;
                    } else if (gradeId === 'grade3') {
                        matches = value > 1.5 && value <= 3.0;
                    } else if (gradeId === 'grade4') {
                        matches = value > 2.5 && value <= 4.0;
                    } else if (gradeId === 'grade5') {
                        matches = value > 3.5 && value <= 6.0;
                    } else if (gradeId === 'grade6') {
                        matches = value > 6.0 || value <= 0.3;
                    }
                } else {
                    // å…¶ä»–åƒæ•¸ä¿æŒåŸä¾†çš„é‚è¼¯
                    if (Array.isArray(condition)) {
                        for (const range of condition) {
                            if (value >= range.min && value <= range.max) {
                                matches = true;
                                break;
                            }
                        }
                    } else {
                        matches = value >= condition.min && value <= condition.max;
                    }
                }
        
                if (matches) {
                    matchingGrades.push({ id: gradeId, ...grade, gradeIndex: parseInt(gradeId.replace('grade', '')) });
                }
            });

            // pNN50å’ŒLFHFï¼šé¸æ“‡è¼ƒåš´é‡çš„ç´šåˆ¥ï¼ˆç´¢å¼•è¼ƒå¤§çš„ï¼‰
            if (matchingGrades.length > 0) {
                matchingGrades.sort((a, b) => b.gradeIndex - a.gradeIndex);
                return matchingGrades[0];
            }
    
            return null;
        }

        function calculateGradingConfidence(params, primaryGrade) {
            let matchingParams = 0;
            let totalParams = 0;
            
            Object.entries(primaryGrade.conditions).forEach(([param, condition]) => {
                if (params[param] !== undefined) {
                    totalParams++;
            
                    if (Array.isArray(condition)) {
                        for (const range of condition) {
                            if (params[param] >= range.min && params[param] <= range.max) {
                                matchingParams++;
                                break;
                            }
                        }
                    } else {
                        if (params[param] >= condition.min && params[param] <= condition.max) {
                            matchingParams++;
                        }
                    }
                }
            });
    
            return totalParams > 0 ? (matchingParams / totalParams) * 100 : 0;
        }

        function displayParameters(params) {
            const container = document.getElementById('parameters');
            container.innerHTML = '';
            
            const parameterOrder = ['RMSSD', 'pNN50', 'LF', 'HF', 'LFHF', 'SDNN'];
            
            parameterOrder.forEach(key => {
                if (params[key] !== undefined) {
                    const value = params[key];
                    const range = systemSettings.parameterRanges[key];
                    
                    let status = 'normal';
                    if (range && (value < range.min || value > range.max)) {
                        status = value < range.min ? 'warning' : 'danger';
                    }
                    
                    const card = document.createElement('div');
                    card.className = `param-card ${status}`;
                    card.innerHTML = `
                        <h4>${key}</h4>
                        <div class="value">${Number.isInteger(value) ? value : value.toFixed(1)}</div>
                    `;
                    
                    container.appendChild(card);
                }
            });
        }

        function displayAnalysis(hrvGrading = null) {
            const resultDiv = document.getElementById('analysisResult');
            const recommendationsDiv = document.getElementById('recommendationsList');

            if (hrvGrading && hrvGrading.primary) {
                resultDiv.innerHTML = `
                    <h3 style="color: ${hrvGrading.primary.color}; margin-bottom: 15px;">${hrvGrading.primary.name}</h3>
                    <p style="margin-bottom: 8px;"><strong>ä¸»è¦ä¾æ“šï¼š</strong>rMSSD å€¼åˆ¤æ–·</p>
                    ${hrvGrading.supplementary.length > 0 ? `<p style="font-size: 0.9em; color: #6b7280; margin-bottom: 8px;"><strong>è£œå……èªªæ˜ï¼š</strong>${hrvGrading.supplementary.join('ã€')}</p>` : ''}
                `;
        
                resultDiv.style.background = `${hrvGrading.primary.color}20`;
                resultDiv.style.borderLeft = `4px solid ${hrvGrading.primary.color}`;
            } else {
                resultDiv.innerHTML = `
                    <h3 style="color: #dc2626;">ç„¡æ³•é€²è¡ŒHRVåˆ†ç´š</h3>
                    <p>è«‹ç¢ºèªè¼¸å…¥çš„æ•¸æ“šæ˜¯å¦æ­£ç¢º</p>
                `;
                resultDiv.style.background = '#fef2f2';
                resultDiv.style.borderLeft = '4px solid #dc2626';
            }

            recommendationsDiv.innerHTML = '';
            const recommendations = getRecommendations(hrvGrading);
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsDiv.appendChild(li);
            });
        }

        function getRecommendations(hrvGrading = null) {
            const recommendations = [];

            // æ·»åŠ HRVåˆ†ç´šçš„å»ºè­°
            if (hrvGrading && hrvGrading.primary && hrvGrading.primary.recommendations) {
                hrvGrading.primary.recommendations.forEach(rec => {
                    if (rec.trim()) recommendations.push(rec);
                });
            }

            // æœ€å¾Œå›ºå®šæ·»åŠ å°ˆæ¥­é†«ç™‚å»ºè­°
            recommendations.push('å»ºè­°è«®è©¢å°ˆæ¥­é†«ç™‚äººå“¡');
            return recommendations;
        }

        function updateSettingsUI() {
            updateParameterRangesUI();
            updateHRVGradingUI();
        }

        function updateHRVGradingUI() {
            const classificationContainer = document.getElementById('classificationList');

            // æ¸…ç©ºåŸæœ‰çš„åˆ†é¡åˆ—è¡¨å…§å®¹
            classificationContainer.innerHTML = '';

            // å‰µå»ºHRVåˆ†ç´šè¨­å®šä¾†å–ä»£åŸæœ‰çš„åˆ†é¡åˆ—è¡¨
            const hrvGradingSection = document.createElement('div');
            hrvGradingSection.className = 'hrv-grading-section';
            hrvGradingSection.innerHTML = `
                <div id="hrvGradesList"></div>
            `;

            // å°‡HRVåˆ†ç´šè¨­å®šæ”¾å…¥åˆ†é¡å®¹å™¨ä¸­
            classificationContainer.appendChild(hrvGradingSection);

            // æ›´æ–°åˆ†ç´šåˆ—è¡¨
            updateHRVGradesList();
        }

        function updateHRVGradesList() {
            const container = document.getElementById('hrvGradesList');
            if (!container) return;
    
            container.innerHTML = '';
    
            Object.entries(systemSettings.hrvGrading.grades).forEach(([gradeId, grade], index) => {
                const gradeItem = document.createElement('div');
                gradeItem.className = 'classification-item hrv-grade-item';
                gradeItem.style.borderLeftColor = grade.color;
        
                gradeItem.innerHTML = `
                    <div class="classification-header">
                        <div><strong>ç´šåˆ¥ ${index + 1}</strong></div>
                    </div>
            
                    <div class="form-group">
                        <label>ç´šåˆ¥åç¨±ï¼š</label>
                        <input type="text" class="form-input" value="${grade.name}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>rMSSD åˆ¤æ–·ç¯„åœ (ä¸»è¦ä¾æ“š)ï¼š</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="form-input" value="${grade.rmssdRange.min}" 
                                onchange="updateHRVGradeRange('${gradeId}', 'min', this.value)" style="flex: 1;">
                            <span>-</span>
                            <input type="number" class="form-input" value="${grade.rmssdRange.max === Infinity ? '' : grade.rmssdRange.max}" 
                                placeholder="ç„¡ä¸Šé™" onchange="updateHRVGradeRange('${gradeId}', 'max', this.value)" style="flex: 1;">
                            <span>ms</span>
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">
                            æ³¨æ„ï¼šç¯„åœåˆ¤æ–·ç‚º ${gradeId === 'grade1' ? '>æœ€å°å€¼' : gradeId === 'grade6' ? 'â‰¤æœ€å¤§å€¼' : 'æœ€å°å€¼ < å€¼ â‰¤ æœ€å¤§å€¼'}
                        </div>
                    </div>
            
                    <div class="form-group">
                        <label>å…¶ä»–åƒæ•¸ç¯„åœ (è£œå……åˆ¤æ–·)ï¼š</label>
                        <div class="parameter-ranges">
                            ${Object.entries(grade.conditions).map(([param, range]) => {
                                if (param === 'LFHF' && Array.isArray(range)) {
                                return `
                                    <div class="param-range">
                                        <strong>${param}:</strong> 
                                        ${range.map(r => `${r.min === 0 ? '<' : ''}${r.min === Infinity ? '>' : r.min}${r.max === Infinity ? '+' : '-' + r.max}`).join(' æˆ– ')}
                                    </div>
                                `;
                                } else {
                                    return `
                                        <div class="param-range">
                                            <strong>${param}:</strong> ${range.min}${range.max === Infinity ? '+' : '-' + range.max}
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
            
                    <div class="form-group">
                        <label>å»ºè­°äº‹é …ï¼š</label>
                        <div class="suggestions-list">
                            ${grade.recommendations.map((rec, recIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${rec}" 
                                       onchange="updateHRVGradeRecommendation('${gradeId}', ${recIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeHRVGradeRecommendation('${gradeId}', ${recIndex})">ç§»é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addHRVGradeRecommendation('${gradeId}')">+ æ–°å¢å»ºè­°</button>
                    </div>
                `;
        
                container.appendChild(gradeItem);
            });
        }

        function updateHRVGradeRange(gradeId, type, value) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade) {
                if (type === 'min') {
                    grade.rmssdRange.min = parseFloat(value) || 0;
                } else {
                    grade.rmssdRange.max = value === '' ? Infinity : parseFloat(value);
                }
            }
        }

        function updateHRVGradeRecommendation(gradeId, index, value) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade && grade.recommendations[index] !== undefined) {
                grade.recommendations[index] = value;
            }
        }

        function addHRVGradeRecommendation(gradeId) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade) {
                grade.recommendations.push('');
                updateHRVGradesList();
            }
        }

        function removeHRVGradeRecommendation(gradeId, index) {
            const grade = systemSettings.hrvGrading.grades[gradeId];
            if (grade && index >= 0) {
                grade.recommendations.splice(index, 1);
                updateHRVGradesList();
            }
        }

        function updateParameterRangesUI() {
    const container = document.getElementById('parameterRanges');
    container.innerHTML = '';
    
    Object.entries(systemSettings.parameterRanges).forEach(([param, range]) => {
        const div = document.createElement('div');
        div.className = 'range-input-group';
        div.dataset.param = param;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆ
        const isMobile = window.innerWidth <= 768;
        
        if (isMobile) {
            div.innerHTML = `
                <div class="param-title">${param}</div>
                <div class="value-inputs">
                    <div class="input-group">
                        <div class="input-label">æœ€å°å€¼</div>
                        <input type="number" class="range-input" value="${range.min}">
                    </div>
                    <div class="input-group">
                        <div class="input-label">æœ€å¤§å€¼</div>
                        <input type="number" class="range-input" value="${range.max}">
                    </div>
                </div>
                <div class="description-input">
                    <div class="input-label">èªªæ˜</div>
                    <input type="text" class="range-input" value="${range.description}">
                </div>
            `;
        } else {
            // æ¡Œé¢ç‰ˆä¿æŒåŸä¾†çš„æ ¼å¼
            div.innerHTML = `
                <label>${param}</label>
                <input type="number" class="range-input" value="${range.min}">
                <input type="number" class="range-input" value="${range.max}">
                <input type="text" class="range-input" value="${range.description}">
            `;
        }
        
        container.appendChild(div);
    });
}

        function updateClassificationUI() {
            const container = document.getElementById('classificationList');
            container.innerHTML = '';
            
            Object.entries(systemSettings.classificationRules).forEach(([type, rule], index) => {
                const item = document.createElement('div');
                item.className = `classification-item ${type}`;
                item.dataset.type = type;
                
                item.innerHTML = `
                    <div class="classification-header">
                        <div><strong>åˆ†é¡ ${index + 1}</strong></div>
                        <button class="delete-btn" onclick="deleteClassification('${type}')">åˆªé™¤</button>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†é¡åç¨±ï¼š</label>
                        <input type="text" class="form-input" value="${rule.name}" 
                               onchange="updateClassificationField('${type}', 'name', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>æè¿°ï¼ˆä»£è¡¨çš„ç‹€æ³ï¼‰ï¼š</label>
                        <textarea class="form-input form-textarea" 
                                  onchange="updateClassificationField('${type}', 'description', this.value)"
                                  placeholder="ä¾‹å¦‚ï¼šå€‹æ€§å®¹æ˜“ç·Šå¼µã€å·¥ä½œå£“åŠ›å¾ˆå¤§ã€ç”Ÿæ´»æ­¥èª¿ç·Šæ¹Šçš„äºº">${rule.description || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>è¤‡åˆåˆ†é¡åŸºæº–ï¼š</label>
                        <input type="text" class="form-input" value="${rule.condition}" 
                               onchange="updateClassificationField('${type}', 'condition', this.value)"
                               placeholder="ä¾‹å¦‚ï¼šLFHF > 2.5">
                    </div>
                    
                    <div class="form-group">
                        <label>ç‡Ÿé¤Šå“è£œå……å»ºè­°ï¼š</label>
                        <div class="suggestions-list" data-type="${type}" data-list="supplements">
                            ${rule.supplements.map((item, itemIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${item}" 
                                           onchange="updateSuggestionItem('${type}', 'supplements', ${itemIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeSuggestionItem('${type}', 'supplements', ${itemIndex})">ç§»é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addSuggestionItem('${type}', 'supplements')">+ æ–°å¢ç‡Ÿé¤Šå“</button>
                    </div>
                    
                    <div class="form-group">
                        <label>ç”Ÿæ´»æ”¹å–„å»ºè­°ï¼š</label>
                        <div class="suggestions-list" data-type="${type}" data-list="lifestyle">
                            ${rule.lifestyle.map((item, itemIndex) => `
                                <div class="suggestion-item">
                                    <input type="text" class="suggestion-input" value="${item}" 
                                           onchange="updateSuggestionItem('${type}', 'lifestyle', ${itemIndex}, this.value)">
                                    <button class="remove-btn" onclick="removeSuggestionItem('${type}', 'lifestyle', ${itemIndex})">ç§»é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-btn" onclick="addSuggestionItem('${type}', 'lifestyle')">+ æ–°å¢å»ºè­°</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function addNewClassification() {
            const existingTypes = Object.keys(systemSettings.classificationRules);
            let newTypeId = 'custom1';
            let counter = 1;
            
            while (existingTypes.includes(newTypeId)) {
                counter++;
                newTypeId = `custom${counter}`;
            }
            
            systemSettings.classificationRules[newTypeId] = {
                name: `è‡ªè¨‚åˆ†é¡ ${counter}`,
                description: '',
                condition: '',
                supplements: [''],
                lifestyle: ['']
            };
            
            updateClassificationUI();
        }

        function deleteClassification(type) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹åˆ†é¡å—ï¼Ÿ')) {
                delete systemSettings.classificationRules[type];
                updateClassificationUI();
            }
        }

        function updateClassificationField(type, field, value) {
            if (systemSettings.classificationRules[type]) {
                systemSettings.classificationRules[type][field] = value;
            }
        }

        function addSuggestionItem(type, listType) {
            const rule = systemSettings.classificationRules[type];
            if (!rule || !rule[listType]) return;
            
            rule[listType].push('');
            updateClassificationUI();
        }

        function removeSuggestionItem(type, listType, index) {
            const rule = systemSettings.classificationRules[type];
            if (!rule || !rule[listType] || index < 0) return;
            
            rule[listType].splice(index, 1);
            updateClassificationUI();
        }

        function updateSuggestionItem(type, listType, index, value) {
            const rule = systemSettings.classificationRules[type];
            if (rule && rule[listType] && index >= 0) {
                rule[listType][index] = value;
            }
        }


function collectClassificationSettings() {
    const rules = {};
    const items = document.querySelectorAll('.classification-item[data-type]');
    
    items.forEach(item => {
        const type = item.dataset.type;
        const inputs = item.querySelectorAll('input, textarea');
        
        // åŸºæœ¬è³‡è¨Š
        const nameInput = item.querySelector('input[type="text"]');
        const descTextarea = item.querySelector('textarea');
        const conditionInputs = item.querySelectorAll('input[type="text"]');
        
        // ç‡Ÿé¤Šå“å»ºè­°
        const suppInputs = item.querySelectorAll('.suggestions-list[data-list="supplements"] input');
        const supplements = Array.from(suppInputs).map(i => i.value.trim()).filter(v => v);
        
        // ç”Ÿæ´»å»ºè­°
        const lifeInputs = item.querySelectorAll('.suggestions-list[data-list="lifestyle"] input');
        const lifestyle = Array.from(lifeInputs).map(i => i.value.trim()).filter(v => v);
        
        rules[type] = {
            name: nameInput ? nameInput.value.trim() : '',
            description: descTextarea ? descTextarea.value.trim() : '',
            condition: conditionInputs[1] ? conditionInputs[1].value.trim() : '',
            supplements: supplements.length > 0 ? supplements : [''],
            lifestyle: lifestyle.length > 0 ? lifestyle : ['']
        };
    });
    
    return rules;
}

function loadSettings() {
    try {
        const savedSettings = localStorage.getItem('hrvSystemSettings');
        if (savedSettings) {
            const parsedSettings = JSON.parse(savedSettings);
            
            // åˆä½µè¨­å®šï¼Œä¿ç•™é è¨­å€¼ä½œç‚ºå‚™ä»½
            if (parsedSettings.parameterRanges) {
                systemSettings.parameterRanges = {
                    ...systemSettings.parameterRanges,
                    ...parsedSettings.parameterRanges
                };
            }
            
            if (parsedSettings.classificationRules) {
                systemSettings.classificationRules = {
                    ...systemSettings.classificationRules,
                    ...parsedSettings.classificationRules
                };
            }
            
            console.log('è¨­å®šå·²è¼‰å…¥');
        }
    } catch (error) {
        console.error('è¼‰å…¥è¨­å®šå¤±æ•—ï¼š', error);
        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä¿æŒä½¿ç”¨é è¨­è¨­å®š
    }
}

        function saveSettings() {
            const paramRanges = {};
            const rangeGroups = document.querySelectorAll('.range-input-group[data-param]');
            
            rangeGroups.forEach(elem => {
                const param = elem.dataset.param;
                const inputs = elem.querySelectorAll('input');
                
                paramRanges[param] = {
                    min: parseFloat(inputs[0].value) || 0,
                    max: parseFloat(inputs[1].value) || 100,
                    description: inputs[2].value || ''
                };
            });
            const classificationRules = collectClassificationSettings();

            systemSettings.parameterRanges = paramRanges;
            systemSettings.classificationRules = classificationRules;

                try {
        localStorage.setItem('hrvSystemSettings', JSON.stringify(systemSettings));
        alert('è¨­å®šå·²å„²å­˜ï¼');
    } catch (error) {
        console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
    }
}

        function resetToDefault() {
            if (confirm('ç¢ºå®šè¦æ¢å¾©é è¨­è¨­å®šå—ï¼Ÿ')) {
                systemSettings.parameterRanges = {
                    'RMSSD': { min: 30, max: 100, description: 'é€£çºŒå¿ƒè·³é–“éš”å·®ç•°' },
                    'pNN50': { min: 10, max: 50, description: 'å¿ƒè·³è®Šç•°ç¨‹åº¦' },
                    'LF': { min: 300, max: 1500, description: 'ä½é »åŠŸç‡' },
                    'HF': { min: 300, max: 1000, description: 'é«˜é »åŠŸç‡' },
                    'LFHF': { min: 0.5, max: 2.5, description: 'è‡ªå¾‹ç¥ç¶“å¹³è¡¡' },
                    'SDNN': { min: 50, max: 150, description: 'å¿ƒè·³è®Šç•°æ¨™æº–å·®' }
                };
                
                systemSettings.classificationRules = {
                    type1: { 
                        name: 'é¡å‹ä¸€ - äº¤æ„Ÿç¥ç¶“éåº¦æ´»èº',
                        description: 'å€‹æ€§å®¹æ˜“ç·Šå¼µã€å·¥ä½œå£“åŠ›å¾ˆå¤§ã€ç”Ÿæ´»æ­¥èª¿ç·Šæ¹Šçš„äºº',
                        condition: 'LFHF > 2.5',
                        supplements: ['ç©€ç¶­ç´ ', 'GABA'],
                        lifestyle: ['æ”¾é¬†ç·´ç¿’', 'æ¸›å°‘å’–å•¡å› ', 'æ·±å‘¼å¸è¨“ç·´']
                    },
                    type2: { 
                        name: 'é¡å‹äºŒ - å‰¯äº¤æ„Ÿç¥ç¶“éåº¦æ´»èº',
                        description: 'æ´»å‹•é‡ä¸è¶³ã€ç¼ºä¹é‹å‹•çš„æ—ç¾¤',
                        condition: 'LFHF < 0.5',
                        supplements: ['å”è¾›å­', 'äººè”˜çš‚ç”˜'],
                        lifestyle: ['é©åº¦é‹å‹•', 'è¦å¾‹ä½œæ¯', 'æå‡æ´»åŠ›']
                    },
                    type3: { 
                        name: 'é¡å‹ä¸‰ - å¤šé …æŒ‡æ¨™ç•°å¸¸',
                        description: 'ç¶œåˆæ€§å•é¡Œï¼Œéœ€è¦å…¨é¢æ€§èª¿ç†',
                        condition: '3å€‹ä»¥ä¸Šåƒæ•¸è¶…å‡ºæ­£å¸¸ç¯„åœ',
                        supplements: ['å”è¾›å­+ç©€ç¶­ç´ ', 'äººè”˜çš‚ç”˜+ç©€ç¶­ç´ '],
                        lifestyle: ['å°±é†«è«®è©¢', 'å¯†åˆ‡ç›£æ§', 'ç¶œåˆèª¿ç†']
                    },
                    normal: { 
                        name: 'æ­£å¸¸ç¯„åœ',
                        description: 'å„é …æŒ‡æ¨™å‡åœ¨å¥åº·ç¯„åœå…§',
                        condition: 'æ‰€æœ‰åƒæ•¸åœ¨æ­£å¸¸ç¯„åœå…§',
                        supplements: ['ç¶­æŒç¾ç‹€'],
                        lifestyle: ['ä¿æŒè‰¯å¥½ç¿’æ…£', 'å®šæœŸæª¢æ¸¬']
                    }
                };
                
                updateSettingsUI();
                alert('å·²æ¢å¾©é è¨­è¨­å®šï¼');
            }
        }

        // ç³»çµ±åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
     
    document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            analyzeData();
        }
    });
    
    // è¨­ç½®æ‹–æ‹½åŠŸèƒ½ï¼ˆåƒ…é™QR Codeï¼‰
    setupDragAndDrop();
    
    // åˆå§‹åŒ–é è¨­è¼¸å…¥æ–¹å¼
    updateStatus('âœï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼', '');
    
    // æ–°å¢ï¼šéŸ¿æ‡‰å¼åµæ¸¬ï¼Œç•¶è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°æ¸²æŸ“è¨­å®šä»‹é¢
    window.addEventListener('resize', function() {
        if (document.getElementById('parameterRanges').innerHTML !== '') {
            updateParameterRangesUI();
        }
    });
});
    </script>
</body>
</html>
